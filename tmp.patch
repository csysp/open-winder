*** Begin Patch
*** Update File: home-secnet/openwrt/templates/etc/config/dhcp.tpl
@@
-config dnsmasq
        option domainneeded '1'
        option boguspriv '1'
        option filterwin2k '0'
        option localise_queries '1'
        option rebind_protection '1'
        option rebind_localhost '1'
        option local '/lan/'
        option domain 'lan'
        option expandhosts '1'
        option nonegcache '0'
        option cachesize '1000'
        option authoritative '1'
        option readethers '1'
        option leasefile '/tmp/dhcp.leases'
        option resolvfile '/tmp/resolv.conf.d/resolv.conf.auto'
        option localservice '1'
        option port '0'

config dhcp 'lan'
        option interface 'lan'
        option start '100'
        option limit '120'
        option leasetime '12h'

config dhcp 'wan'
        option interface 'wan'
        option ignore '1'


+config dnsmasq
        option domainneeded '1'
        option boguspriv '1'
        option filterwin2k '0'
        option localise_queries '1'
        option rebind_protection '1'
        option rebind_localhost '1'
        option local '/lan/'
        option domain 'lan'
        option expandhosts '1'
        option nonegcache '0'
        option cachesize '1000'
        option authoritative '1'
        option readethers '1'
        option leasefile '/tmp/dhcp.leases'
        option resolvfile '/tmp/resolv.conf.d/resolv.conf.auto'
        option localservice '1'
        option port '0'

config dhcp 'lan'
        option interface 'lan'
        option start '100'
        option limit '120'
        option leasetime '12h'

config dhcp 'wan'
        option interface 'wan'
        option ignore '1'


*** Move to: home-secnet/openwrt/templates/etc/config/dhcp.template
*** Update File: home-secnet/openwrt/templates/etc/config/system.tpl
@@
-config system
        option hostname '${ROUTER_HOSTNAME}'
        option timezone '${TZ}'
        option ttylogin '0'
        option log_size '128'


+config system
        option hostname '${ROUTER_HOSTNAME}'
        option timezone '${TZ}'
        option ttylogin '0'
        option log_size '128'


*** Move to: home-secnet/openwrt/templates/etc/config/system.template
*** Update File: home-secnet/openwrt/templates/etc/config/network.tpl
@@
-config interface 'loopback'
        option device 'lo'
        option proto 'static'
        option ipaddr '127.0.0.1'
        option netmask '255.0.0.0'

config interface 'lan'
        option proto 'static'
        option device '${LAN_IF}'
        option ipaddr '${LAN_ADDR}'
        option netmask '${LAN_NETMASK}'

config interface 'wan'
        option device '${WAN_IF}'
        option proto 'dhcp'

config interface 'wg0'
        option proto 'wireguard'
        option private_key '${WG_SERVER_PRIVKEY}'
        list addresses '${WG_SERVER_IP}'
        option listen_port '${WG_PORT}'

+config interface 'loopback'
        option device 'lo'
        option proto 'static'
        option ipaddr '127.0.0.1'
        option netmask '255.0.0.0'

config interface 'lan'
        option proto 'static'
        option device '${LAN_IF}'
        option ipaddr '${LAN_ADDR}'
        option netmask '${LAN_NETMASK}'

config interface 'wan'
        option device '${WAN_IF}'
        option proto 'dhcp'

config interface 'wg0'
        option proto 'wireguard'
        option private_key '${WG_SERVER_PRIVKEY}'
        list addresses '${WG_SERVER_IP}'
        option listen_port '${WG_PORT}'

*** Move to: home-secnet/openwrt/templates/etc/config/network.template
*** Update File: home-secnet/openwrt/templates/etc/config/firewall.tpl
@@
-config defaults
        option input 'DROP'
        option output 'ACCEPT'
        option forward 'DROP'
        option synflood_protect '1'
        option custom_chains '1'

config zone
        option name 'lan'
        list   network 'lan'
        option input 'ACCEPT'
        option output 'ACCEPT'
        option forward 'DROP'

config zone
       option name 'wan'
       list   network 'wan'
       option input 'DROP'
       option output 'ACCEPT'
       option forward 'DROP'
       option masq '1'
       option mtu_fix '1'

config forwarding
        option src 'lan'
        option dest 'wan'

config rule
        option name 'Allow-DHCP-From-LAN'
        option src 'lan'
        option proto 'udp'
        option dest_port '67-68'
        option target 'ACCEPT'

config rule
        option name 'Allow-DNS-From-LAN'
        option src 'lan'
        option proto 'tcp udp'
        option dest_port '53'
        option target 'ACCEPT'

config include
        option type 'nftables'
        option path '/etc/nftables.d/99-wg-spa.nft'

+config defaults
        option input 'DROP'
        option output 'ACCEPT'
        option forward 'DROP'
        option synflood_protect '1'
        option custom_chains '1'

config zone
        option name 'lan'
        list   network 'lan'
        option input 'ACCEPT'
        option output 'ACCEPT'
        option forward 'DROP'

config zone
       option name 'wan'
       list   network 'wan'
       option input 'DROP'
       option output 'ACCEPT'
       option forward 'DROP'
       option masq '1'
       option mtu_fix '1'

config forwarding
        option src 'lan'
        option dest 'wan'

config rule
        option name 'Allow-DHCP-From-LAN'
        option src 'lan'
        option proto 'udp'
        option dest_port '67-68'
        option target 'ACCEPT'

config rule
        option name 'Allow-DNS-From-LAN'
        option src 'lan'
        option proto 'tcp udp'
        option dest_port '53'
        option target 'ACCEPT'

config include
        option type 'nftables'
        option path '/etc/nftables.d/99-wg-spa.nft'

*** Move to: home-secnet/openwrt/templates/etc/config/firewall.template
*** Update File: home-secnet/openwrt/templates/etc/adguardhome.yaml.tpl
@@
-bind_host: 0.0.0.0
bind_port: 53
schema_version: 27
users: []
http:
  address: ${ADGUARD_UI_LISTEN}
dns:
  upstream_dns:
    - '127.0.0.1:5353'
  bootstrap_dns:
    - '9.9.9.9'
    - '1.1.1.1'
  enable_dnssec: true
  serve_http3: false
  ratelimit: 0
filters:
  - enabled: ${DNS_BLOCKLISTS_MIN}
    url: https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
    name: AdGuard Base Minimal
    id: 1

+bind_host: 0.0.0.0
bind_port: 53
schema_version: 27
users: []
http:
  address: ${ADGUARD_UI_LISTEN}
dns:
  upstream_dns:
    - '127.0.0.1:5353'
  bootstrap_dns:
    - '9.9.9.9'
    - '1.1.1.1'
  enable_dnssec: true
  serve_http3: false
  ratelimit: 0
filters:
  - enabled: ${DNS_BLOCKLISTS_MIN}
    url: https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
    name: AdGuard Base Minimal
    id: 1

*** Move to: home-secnet/openwrt/templates/etc/adguardhome.yaml.template
*** Update File: home-secnet/openwrt/templates/etc/unbound/unbound.conf.tpl
@@
-server:
    username: "unbound"
    directory: "/var/lib/unbound"
    chroot: ""
    pidfile: "/var/run/unbound.pid"
    root-hints: "/etc/unbound/root.hints"
    auto-trust-anchor-file: "/var/lib/unbound/root.key"
    tls-cert-bundle: "/etc/ssl/certs/ca-certificates.crt"
    interface: 127.0.0.1@5353
    access-control: 127.0.0.0/8 allow
    hide-identity: yes
    hide-version: yes
    qname-minimisation: yes
    harden-dnssec-stripped: yes
    harden-referral-path: yes
    rrset-roundrobin: yes
    prefetch: yes
    cache-min-ttl: 120
    cache-max-ttl: 86400

forward-zone:
    name: "."
    forward-tls-upstream: yes
    forward-addr: 9.9.9.9@853#dns.quad9.net
    forward-addr: 1.1.1.1@853#cloudflare-dns.com


+server:
    username: "unbound"
    directory: "/var/lib/unbound"
    chroot: ""
    pidfile: "/var/run/unbound.pid"
    root-hints: "/etc/unbound/root.hints"
    auto-trust-anchor-file: "/var/lib/unbound/root.key"
    tls-cert-bundle: "/etc/ssl/certs/ca-certificates.crt"
    interface: 127.0.0.1@5353
    access-control: 127.0.0.0/8 allow
    hide-identity: yes
    hide-version: yes
    qname-minimisation: yes
    harden-dnssec-stripped: yes
    harden-referral-path: yes
    rrset-roundrobin: yes
    prefetch: yes
    cache-min-ttl: 120
    cache-max-ttl: 86400

forward-zone:
    name: "."
    forward-tls-upstream: yes
    forward-addr: 9.9.9.9@853#dns.quad9.net
    forward-addr: 1.1.1.1@853#cloudflare-dns.com


*** Move to: home-secnet/openwrt/templates/etc/unbound/unbound.conf.template
*** Update File: home-secnet/openwrt/templates/etc/nftables.d/99-wg-spa.nft.tpl
@@
-table inet fw4 {
  set wg_spa_allow {
    type ipv4_addr;
    flags timeout;
  }

  chain input {
    # Only allow WireGuard UDP if source IP is in the SPA allow set
    udp dport ${WG_PORT} ip saddr @wg_spa_allow accept
  }
}

+table inet fw4 {
  set wg_spa_allow {
    type ipv4_addr;
    flags timeout;
  }

  chain input {
    # Only allow WireGuard UDP if source IP is in the SPA allow set
    udp dport ${WG_PORT} ip saddr @wg_spa_allow accept
  }
}

*** Move to: home-secnet/openwrt/templates/etc/nftables.d/99-wg-spa.nft.template
*** End Patch
