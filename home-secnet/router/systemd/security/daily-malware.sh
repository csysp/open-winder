#!/usr/bin/env bash
set -euo pipefail
LOGDIR=/var/log/clamav
mkdir -p "$LOGDIR"
if command -v freshclam >/dev/null 2>&1; then freshclam || true; fi
# Scan critical paths to reduce load
paths=(/etc /bin /sbin /usr /var /opt)
if command -v clamscan >/dev/null 2>&1; then
  clamscan -r --infected --log="$LOGDIR/scan.log" "${paths[@]}"
  rc=$?
  ALERT_SH="/opt/router/security/alert-mail.sh"
  if [[ -x "$ALERT_SH" ]]; then
    if [[ $rc -eq 1 ]]; then
      "$ALERT_SH" "[home-secnet][router] ClamAV infected files" "ClamAV detected infected files. See $LOGDIR/scan.log"
    elif [[ $rc -ge 2 ]]; then
      "$ALERT_SH" "[home-secnet][router] ClamAV scan error" "ClamAV encountered errors. Exit $rc. See $LOGDIR/scan.log"
    fi
  fi
fi
