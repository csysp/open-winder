name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  rust:
    name: Rust fmt/clippy/build/test
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy
      - name: Build server
        working-directory: home-secnet/router/spa-pq
        run: |
          cargo fmt --all -- --check
          cargo clippy --all-targets -- -D warnings
          cargo build --release
          cargo test --all
      - name: Build client (manifest-path)
        run: |
          cargo fmt --manifest-path home-secnet/clients/spa-pq-client/Cargo.toml --all -- --check
          cargo clippy --manifest-path home-secnet/clients/spa-pq-client/Cargo.toml --all-targets -- -D warnings
          cargo build --manifest-path home-secnet/clients/spa-pq-client/Cargo.toml --release
          cargo test --manifest-path home-secnet/clients/spa-pq-client/Cargo.toml --all || true

  shell:
    name: Shell lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Shellcheck scripts
        run: |
          shopt -s globstar || true
          shellcheck -S warning home-secnet/scripts/**/*.sh home-secnet/tests/*.sh || true
